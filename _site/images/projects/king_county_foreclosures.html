<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>king_county_foreclosures</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
    <!-- Custom stylesheet, it must be in the same directory as the html file -->
    <link rel="stylesheet" href="custom.css">

    <!-- Load mathjax -->
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML-full,Safe"> </script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: {
                    automatic: true
                    }
                }
            });

            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
    <!-- End of mathjax configuration -->
</head>

<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">

    <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
        <div class="jp-Cell-inputWrapper">
            <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
            </div>
            <div class="jp-InputArea jp-Cell-inputArea">
                <div class="jp-InputPrompt jp-InputArea-prompt">
                </div>
                <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput "
                    data-mime-type="text/markdown">
                    <h1 id="(Seattle,-WA)-Distressed-Property-Dashboard-Project">(Seattle, WA) Distressed Property
                        Dashboard Project<a class="anchor-link"
                            href="#(Seattle,-WA)-Distressed-Property-Dashboard-Project">&#182;</a></h1>
                    <h2 id="Python,-SQL-and-Tableau:-Data-Extraction,-Key-Metrics,-Dashboard">Python: Data Extraction<a
                            class="anchor-link"
                            href="#Python,-SQL-and-Tableau:-Data-Extraction,-Key-Metrics,-Dashboard">&#182;</a></h2>
                    <ul>
                        <li>Data Sources: King County Records, Assessor Parcel Website</li>
                        <li>Dataset: Custom</li>
                        <li>Export Option: SQL database</li>
                        <li>Data Transformations: Concat multiple fields, remove unknown columns</li>
                        <li>Future changes: Add historical trend column</li>
                    </ul>

                </div>
            </div>
        </div>
    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
        <div class="jp-Cell-inputWrapper">
            <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
            </div>
            <div class="jp-InputArea jp-Cell-inputArea">
                <div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[53]:</div>
                <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
                    <div class="CodeMirror cm-s-jupyter">
                        <div class=" highlight hl-ipython3">
                            <pre><span></span><span class="c1"># Imports</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.chrome.service</span> <span class="kn">import</span> <span class="n">Service</span>
<span class="kn">from</span> <span class="nn">webdriver_manager.chrome</span> <span class="kn">import</span> <span class="n">ChromeDriverManager</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.by</span> <span class="kn">import</span> <span class="n">By</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">findall</span><span class="p">,</span> <span class="n">sub</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">geopy.geocoders</span> <span class="kn">import</span> <span class="n">Nominatim</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">notebook</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
</pre>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
        <div class="jp-Cell-inputWrapper">
            <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
            </div>
            <div class="jp-InputArea jp-Cell-inputArea">
                <div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[54]:</div>
                <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
                    <div class="CodeMirror cm-s-jupyter">
                        <div class=" highlight hl-ipython3">
                            <pre><span></span><span class="c1"># Set current directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">'/home/jovyan/work'</span><span class="p">)</span>

<span class="c1"># Setup chromedriver</span>
<span class="n">options</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">ChromeOptions</span><span class="p">()</span>
<span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'headless'</span><span class="p">)</span>
<span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--no-sandbox'</span><span class="p">)</span>
<span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--disable-dev-shm-usage'</span><span class="p">)</span>

<span class="c1"># Set constants</span>
<span class="n">records_url</span> <span class="o">=</span> <span class="s2">"https://recordsearch.kingcounty.gov/LandmarkWeb/search/index?theme=.blue&amp;section=searchCriteriaDocuments&amp;quickSearchSelection="</span>
<span class="n">pid_url</span> <span class="o">=</span> <span class="s1">'https://blue.kingcounty.com/Assessor/eRealProperty/Detail.aspx?ParcelNbr='</span>
</pre>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
        <div class="jp-Cell-inputWrapper">
            <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
            </div>
            <div class="jp-InputArea jp-Cell-inputArea">
                <div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[55]:</div>
                <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
                    <div class="CodeMirror cm-s-jupyter">
                        <div class=" highlight hl-ipython3">
                            <pre><span></span><span class="c1"># Get driver</span>
<span class="k">def</span> <span class="nf">driver_open</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">records_url</span><span class="p">):</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Chrome</span><span class="p">(</span><span class="n">service</span><span class="o">=</span><span class="n">Service</span><span class="p">(</span><span class="n">ChromeDriverManager</span><span class="p">()</span><span class="o">.</span><span class="n">install</span><span class="p">()),</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">set_window_size</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span><span class="mi">850</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">driver</span>

<span class="c1"># Get record for given time period</span>
<span class="k">def</span> <span class="nf">get_records_from_dates</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">n_iter</span><span class="p">,</span><span class="n">driver</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">li_doctype</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'searchCriteriaDocuments-tab'</span><span class="p">)</span>
        <span class="n">li_doctype</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">text_area</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'documentType-DocumentType'</span><span class="p">)</span>
        <span class="n">text_area</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s2">"NTS"</span><span class="p">)</span>

    <span class="n">b_date</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'beginDate-DocumentType'</span><span class="p">)</span>
    <span class="n">b_date</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">b_date</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">beg</span><span class="p">)</span>

    <span class="n">e_date</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'endDate-DocumentType'</span><span class="p">)</span>
    <span class="n">e_date</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">e_date</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

    <span class="n">submit</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'submit-DocumentType'</span><span class="p">)</span>
    <span class="n">submit</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="s2">"window.scrollTo(0, document.body.scrollHeight);"</span><span class="p">)</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">save_screenshot</span><span class="p">(</span><span class="sa">f</span><span class="s1">'tmp/screenshot.png'</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">page_source</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'#'</span><span class="p">,</span><span class="s1">'Unnamed: 1'</span><span class="p">,</span> <span class="s1">'Unnamed: 2'</span><span class="p">,</span> 
                        <span class="s1">'Unnamed: 4'</span><span class="p">,</span> <span class="s1">'Book'</span><span class="p">,</span> <span class="s1">'Book Type'</span><span class="p">,</span>
                        <span class="s1">'DocLinks.1'</span><span class="p">,</span><span class="s1">'Unnamed: 15'</span><span class="p">,</span> <span class="s1">'Page'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df</span>
  
<span class="c1"># Get complete dataframe</span>
<span class="k">def</span> <span class="nf">fetch_records</span><span class="p">(</span><span class="n">n_weeks</span><span class="p">):</span>
    <span class="n">date_format</span> <span class="o">=</span> <span class="s2">"%m/</span><span class="si">%d</span><span class="s2">/%Y"</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_weeks</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">date_format</span><span class="p">))</span> 
        <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">date_format</span><span class="p">))</span> 
        <span class="n">x</span> <span class="o">=</span> <span class="n">end</span>
    <span class="n">dates_reversed</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Looking up records for the week(s) of'</span><span class="p">,</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dates_reversed</span><span class="p">[::</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">driver_open</span><span class="p">()</span>
    <span class="n">n_dates</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Fetching records now'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">notebook</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_dates</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="n">n_dates</span><span class="p">):</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">{:02}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">partial</span> <span class="o">=</span> <span class="n">get_records_from_dates</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">driver</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span><span class="n">partial</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># Get Address and Appraised Value</span>
<span class="k">def</span> <span class="nf">add_details_cols</span><span class="p">(</span><span class="n">pids</span><span class="p">):</span>
    <span class="n">address_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">appraised_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">'Adding parcel info'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">notebook</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">pids</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">)):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">pid_url</span> <span class="o">+</span> <span class="n">pid</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">'html.parser'</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">address_cell</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'table'</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="s1">'cphContent_DetailsViewParcel'</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">'td'</span><span class="p">)[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">address_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">address_cell</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="n">appraise_cell</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'table'</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="s1">'cphContent_GridViewTaxRoll'</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">'td'</span><span class="p">)[</span><span class="mi">7</span><span class="p">]</span>
            <span class="n">appraised_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">appraise_cell</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">address_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">appraised_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">address_list</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">appraised_list</span><span class="p">)</span>

<span class="c1"># Get Location</span>
<span class="k">def</span> <span class="nf">add_location_cols</span><span class="p">(</span><span class="n">addresses</span><span class="p">):</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hood</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">metro</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">geolocator</span> <span class="o">=</span> <span class="n">Nominatim</span><span class="p">(</span><span class="n">user_agent</span><span class="o">=</span><span class="s2">"KingCounty"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">'Adding location info'</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>  
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">notebook</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">addresses</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">addresses</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">location</span> <span class="o">=</span> <span class="n">geolocator</span><span class="o">.</span><span class="n">geocode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="o">+</span> <span class="s1">', WA'</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">location</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">location</span> <span class="ow">and</span> <span class="n">location</span><span class="o">.</span><span class="n">raw</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">raw</span><span class="p">[</span><span class="s1">'display_name'</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">', '</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span>
                <span class="n">lon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span>
                <span class="n">address</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">raw</span><span class="p">[</span><span class="s1">'display_name'</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
                <span class="n">hood</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">metro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">lon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">hood</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">metro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'An error occurred: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="n">location</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">hood</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">metro</span><span class="p">)</span>

<span class="c1"># Add PID, Address, Apprased Value to dataframe</span>
<span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="c1"># Apply hashing function to the column</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">'Grantor'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'Grantor'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">'PID'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'Legal'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'PID'</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">''</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'Legal'</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">'Address'</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">'Appraised Value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">add_details_cols</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'PID'</span><span class="p">]))</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">'Latitude'</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">'Longitude'</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">'Neighborhood'</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">'Metro'</span><span class="p">]</span> <span class="o">=</span> <span class="n">add_location_cols</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'Address'</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">df</span>


<span class="c1"># check if local file is older than 1 week</span>
<span class="k">def</span> <span class="nf">isWeek_old</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="sa">f</span><span class="s1">'data/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.csv'</span><span class="p">)</span>
    <span class="n">org</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
    <span class="n">is_old</span> <span class="o">=</span> <span class="n">org</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">is_old</span>

<span class="c1">#  Load Date</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">n_weeks</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">fetch_records</span><span class="p">(</span><span class="n">n_weeks</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Dataframe appears to be empty, please try again later..."</span><span class="p">)</span>
        
        <span class="n">org_rows</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">'Address'</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">org_rows</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> were deleted'</span><span class="p">)</span>
        
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">'data/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.csv'</span><span class="p">)</span> 
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Save to file: data/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.csv'</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<span class="c1"># Cache dataset to local disk or reload and save if older than 1 week</span>
<span class="k">def</span> <span class="nf">refresh_data</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># init data fetch first time</span>
    <span class="k">if</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.csv'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">'data'</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">n_weeks</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    
    <span class="c1"># refresh data if old</span>
    <span class="k">elif</span> <span class="n">isWeek_old</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">date_format</span> <span class="o">=</span> <span class="s2">"%m/</span><span class="si">%d</span><span class="s2">/%Y"</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">'data/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.csv'</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="s1">'Unnamed: 0'</span><span class="p">)</span>
        <span class="n">last_update</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'Record Date'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">last_update</span><span class="p">,</span><span class="n">date_format</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">n_weeks</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">days</span><span class="o">/</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">n_weeks</span><span class="o">=</span><span class="n">n_weeks</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">'data/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.csv'</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="s1">'Unnamed: 0'</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">df</span>
</pre>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
        <div class="jp-Cell-inputWrapper">
            <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
            </div>
            <div class="jp-InputArea jp-Cell-inputArea">
                <div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[56]:</div>
                <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
                    <div class="CodeMirror cm-s-jupyter">
                        <div class=" highlight hl-ipython3">
                            <pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">refresh_data</span><span class="p">(</span><span class="s1">'seattle-distressed-properties'</span><span class="p">)</span>
</pre>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="jp-Cell-outputWrapper">
            <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
            </div>


            <div class="jp-OutputArea jp-Cell-outputArea">
                <div class="jp-OutputArea-child">

                    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>


                    <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
                        <pre>Looking up records for the week(s) of 06/20/2022, 06/28/2022, 07/06/2022, 07/14/2022, 07/22/2022, 07/30/2022, 08/07/2022, 08/15/2022, 08/23/2022, 08/31/2022, 09/08/2022, 09/16/2022
Fetching records now
</pre>
                    </div>
                </div>
                <div class="jp-OutputArea-child">

                    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>




                    <div class="jp-RenderedText jp-OutputArea-output " data-mime-type="text/plain">
                        <pre>  0%|          | 0/12 [00:00&lt;?, ?it/s]</pre>
                    </div>

                </div>
                <div class="jp-OutputArea-child">

                    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>


                    <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
                        <pre>Adding parcel info
</pre>
                    </div>
                </div>
                <div class="jp-OutputArea-child">

                    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>




                    <div class="jp-RenderedText jp-OutputArea-output " data-mime-type="text/plain">
                        <pre>  0%|          | 0/170 [00:00&lt;?, ?it/s]</pre>
                    </div>

                </div>
                <div class="jp-OutputArea-child">

                    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>


                    <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
                        <pre>Adding location info
</pre>
                    </div>
                </div>
                <div class="jp-OutputArea-child">

                    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>




                    <div class="jp-RenderedText jp-OutputArea-output " data-mime-type="text/plain">
                        <pre>  0%|          | 0/170 [00:00&lt;?, ?it/s]</pre>
                    </div>

                </div>
                <div class="jp-OutputArea-child">

                    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>


                    <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
                        <pre>36 were deleted
Save to file: data/seattle-distressed-properties.csv
</pre>
                    </div>
                </div>

            </div>

        </div>

    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
        <div class="jp-Cell-inputWrapper">
            <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
            </div>
            <div class="jp-InputArea jp-Cell-inputArea">
                <div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[62]:</div>
                <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
                    <div class="CodeMirror cm-s-jupyter">
                        <div class=" highlight hl-ipython3">
                            <pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="jp-Cell-outputWrapper">
            <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
            </div>


            <div class="jp-OutputArea jp-Cell-outputArea">
                <div class="jp-OutputArea-child">

                    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>


                    <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
                        <pre>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 134 entries, 0 to 169
Data columns (total 14 columns):
 #   Column           Non-Null Count  Dtype  
---  ------           --------------  -----  
 0   Status           134 non-null    object 
 1   Grantor          134 non-null    object 
 2   Grantee          134 non-null    object 
 3   Record Date      134 non-null    object 
 4   Doc Type         134 non-null    object 
 5   Rec. #           134 non-null    int64  
 6   DocLinks         134 non-null    object 
 7   PID              134 non-null    object 
 8   Address          134 non-null    object 
 9   Appraised Value  134 non-null    object 
 10  Latitude         134 non-null    float64
 11  Longitude        134 non-null    float64
 12  Neighborhood     134 non-null    object 
 13  Metro            134 non-null    object 
dtypes: float64(2), int64(1), object(11)
memory usage: 15.7+ KB
</pre>
                    </div>
                </div>

            </div>

        </div>

    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
        <div class="jp-Cell-inputWrapper">
            <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
            </div>
            <div class="jp-InputArea jp-Cell-inputArea">
                <div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[67]:</div>
                <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
                    <div class="CodeMirror cm-s-jupyter">
                        <div class=" highlight hl-ipython3">
                            <pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">'Address'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="jp-Cell-outputWrapper">
            <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
            </div>


            <div class="jp-OutputArea jp-Cell-outputArea">
                <div class="jp-OutputArea-child jp-OutputArea-executeResult">

                    <div class="jp-OutputPrompt jp-OutputArea-prompt">Out[67]:</div>




                    <div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult"
                        data-mime-type="text/plain">
                        <pre>array([False])</pre>
                    </div>

                </div>

            </div>

        </div>

    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
        <div class="jp-Cell-inputWrapper">
            <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
            </div>
            <div class="jp-InputArea jp-Cell-inputArea">
                <div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[59]:</div>
                <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
                    <div class="CodeMirror cm-s-jupyter">
                        <div class=" highlight hl-ipython3">
                            <pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">'postgresql://postgres:headband@192.168.0.151:5432/mydb'</span><span class="p">)</span>
</pre>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
        <div class="jp-Cell-inputWrapper">
            <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
            </div>
            <div class="jp-InputArea jp-Cell-inputArea">
                <div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[60]:</div>
                <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
                    <div class="CodeMirror cm-s-jupyter">
                        <div class=" highlight hl-ipython3">
                            <pre><span></span><span class="sd">"""</span>
<span class="sd">Note to self: inlcude a unique index to use for postgres database insert functionality</span>

<span class="sd">CREATE UNIQUE INDEX CONCURRENTLY seattle_rec_num </span>
<span class="sd">ON SeattleDistressedProp ("Rec. #");</span>

<span class="sd">ALTER TABLE SeattleDistressedProp </span>
<span class="sd">ADD CONSTRAINT unique_rec_num </span>
<span class="sd">UNIQUE USING INDEX seattle_rec_num;</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">update_server</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
    <span class="n">table_exists</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">'SELECT EXISTS (SELECT FROM pg_tables '</span>
    <span class="s1">'WHERE schemaname = </span><span class="se">\'</span><span class="s1">public</span><span class="se">\'</span><span class="s1"> AND '</span>
    <span class="sa">f</span><span class="s1">'tablename  = </span><span class="se">\'</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="se">\'</span><span class="s1">);'</span>
    <span class="p">)</span>
    
    <span class="n">row_count</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">'SELECT count(*) '</span>
    <span class="sa">f</span><span class="s1">'FROM "</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s1">";'</span>
    <span class="p">)</span>
  
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">table_exists</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">org_rows</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">row_count</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">'"'</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="s1">'"'</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)])</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">'INSERT INTO "</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s1">"(</span><span class="si">{</span><span class="n">cols</span><span class="si">}</span><span class="s1">) '</span>
            <span class="sa">f</span><span class="s1">'VALUES </span><span class="si">{</span><span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_records</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))])</span><span class="si">}</span><span class="s1"> '</span>
            <span class="sa">f</span><span class="s1">'ON CONFLICT ("Rec. #") DO NOTHING;'</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">new_rows</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">row_count</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">diff_rows</span> <span class="o">=</span> <span class="n">new_rows</span> <span class="o">-</span> <span class="n">org_rows</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">diff_rows</span><span class="p">,</span><span class="s1">' rows added'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">if_exists</span><span class="o">=</span><span class="s1">'replace'</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Successfully updated server'</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Got an error while updating server'</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Error: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
</pre>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
        <div class="jp-Cell-inputWrapper">
            <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
            </div>
            <div class="jp-InputArea jp-Cell-inputArea">
                <div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[61]:</div>
                <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
                    <div class="CodeMirror cm-s-jupyter">
                        <div class=" highlight hl-ipython3">
                            <pre><span></span><span class="n">update_server</span><span class="p">(</span><span class="s2">"SeattleDistressedProp"</span><span class="p">)</span>
</pre>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="jp-Cell-outputWrapper">
            <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
            </div>


            <div class="jp-OutputArea jp-Cell-outputArea">
                <div class="jp-OutputArea-child">

                    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>


                    <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
                        <pre>Successfully updated server
</pre>
                    </div>
                </div>

            </div>

        </div>

    </div>
</body>







</html>