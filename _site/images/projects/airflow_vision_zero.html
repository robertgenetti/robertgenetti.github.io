<!DOCTYPE html>
<html>
<head><meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Untitled</title><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>

<!-- Custom stylesheet, it must be in the same directory as the html file -->
<link rel="stylesheet" href="custom.css">

<!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML-full,Safe"> </script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: {
                    automatic: true
                    }
                }
            });

            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
    <!-- End of mathjax configuration --></head>
<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[&nbsp;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>


<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pendulum</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">airflow.decorators</span> <span class="kn">import</span> <span class="n">dag</span><span class="p">,</span> <span class="n">task</span>


<span class="n">crash_uri</span> <span class="o">=</span> <span class="s1">&#39;https://gisdata-csj.opendata.arcgis.com/datasets/CSJ::crash-locations.csv?outSR=%7B</span><span class="si">%22la</span><span class="s1">testWkid</span><span class="si">%22%</span><span class="s1">3A2227%2C%22wkid</span><span class="si">%22%</span><span class="s1">3A102643%7D&#39;</span><span class="p">;</span>
<span class="n">vehicles_uri</span> <span class="o">=</span> <span class="s1">&#39;https://gisdata-csj.opendata.arcgis.com/datasets/CSJ::crash-vehicles-involved.csv?outSR=%7B</span><span class="si">%22la</span><span class="s1">testWkid</span><span class="si">%22%</span><span class="s1">3A2227%2C%22wkid</span><span class="si">%22%</span><span class="s1">3A102643%7D&#39;</span><span class="p">;</span>
<span class="n">safety_corridors_uri</span> <span class="o">=</span> <span class="s1">&#39;https://gisdata-csj.opendata.arcgis.com/datasets/CSJ::vision-zero-safety-corridors.csv?outSR=%7B</span><span class="si">%22la</span><span class="s1">testWkid</span><span class="si">%22%</span><span class="s1">3A2227%2C%22wkid</span><span class="si">%22%</span><span class="s1">3A102643%7D&#39;</span><span class="p">;</span>


<span class="nd">@dag</span><span class="p">(</span>
    <span class="n">schedule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">pendulum</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;US/Pacific&quot;</span><span class="p">),</span>
    <span class="n">catchup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">vision_zero_crash</span><span class="p">():</span>
    
    <span class="nd">@task</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">etl</span><span class="p">():</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">crash_uri</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;vision_zero_crash&#39;</span>
        <span class="n">dbpasswd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SHARED_PASSWORD&#39;</span><span class="p">]</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;postgresql://shared:</span><span class="si">{</span><span class="n">dbpasswd</span><span class="si">}</span><span class="s1">@postgres:5432/shared&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

    <span class="n">etl</span><span class="p">()</span>

<span class="n">vision_zero_crash</span><span class="p">()</span>



<span class="nd">@dag</span><span class="p">(</span>
    <span class="n">schedule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">pendulum</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;US/Pacific&quot;</span><span class="p">),</span>
    <span class="n">catchup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">vision_zero_vehicles</span><span class="p">():</span>
    
    <span class="nd">@task</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">etl</span><span class="p">():</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">vehicles_uri</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;vision_zero_vehicles&#39;</span>
        <span class="n">dbpasswd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SHARED_PASSWORD&#39;</span><span class="p">]</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;postgresql://shared:</span><span class="si">{</span><span class="n">dbpasswd</span><span class="si">}</span><span class="s1">@postgres:5432/shared&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

    <span class="n">etl</span><span class="p">()</span>
<span class="n">vision_zero_vehicles</span><span class="p">()</span>



<span class="nd">@dag</span><span class="p">(</span>
    <span class="n">schedule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">pendulum</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;US/Pacific&quot;</span><span class="p">),</span>
    <span class="n">catchup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">vision_zero_safety_corridors</span><span class="p">():</span>
    
    <span class="nd">@task</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">etl</span><span class="p">():</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">safety_corridors_uri</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;vision_zero_safety_corridors&#39;</span>
        <span class="n">dbpasswd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SHARED_PASSWORD&#39;</span><span class="p">]</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;postgresql://shared:</span><span class="si">{</span><span class="n">dbpasswd</span><span class="si">}</span><span class="s1">@postgres:5432/shared&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

    <span class="n">etl</span><span class="p">()</span>

<span class="n">vision_zero_safety_corridors</span><span class="p">()</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
</body>







</html>
